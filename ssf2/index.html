<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruffle Game Loader Completo</title>
<style>
html, body { margin: 0; padding: 0; height: 100%; width: 100%; background: black; overflow: hidden; }
#container { position: relative; display: flex; justify-content: center; align-items: center; width: 100vw; height: 100vh; background-color: black; overflow: hidden; }
#player { aspect-ratio: 16 / 9; height: 100%; max-height: 100vh; max-width: 100vw; pointer-events: auto; background: #000; position: relative; z-index: 5; }
.border { position: absolute; z-index: 1; background-repeat: no-repeat; background-size: cover; background-position: center; }
#left-border, #right-border { top: 0; width: calc((100vw - (100vh * 16 / 9)) / 2); height: 100vh; }
#left-border { left: 0; background-image: url('RuffleAndroid/RuffleVKTextures/left_edge.png'); }
#right-border { right: 0; background-image: url('RuffleAndroid/RuffleVKTextures/right_edge.png'); }
#top-border, #bottom-border { left: 0; width: 100vw; height: calc((100vh - (100vw * 9 / 16)) / 2); }
#top-border { top: 0; background-image: url('RuffleAndroid/RuffleVKTextures/top_edge.png'); }
#bottom-border { bottom: 0; background-image: url('RuffleAndroid/RuffleVKTextures/bottom_edge.png'); }
@media (min-aspect-ratio: 16/9) { #top-border, #bottom-border { display: none; } }
@media (max-aspect-ratio: 16/9) { #left-border, #right-border { display: none; } }
#fileControls { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10; color: white; display: flex; gap: 10px; }
input[type="file"] { display: none; }
label.fileLabel { padding: 6px 12px; background: #333; color: white; border-radius: 4px; cursor: pointer; }
</style>
</head>
<body>

<div id="container">
    <div id="left-border" class="border"></div>
    <div id="right-border" class="border"></div>
    <div id="top-border" class="border"></div>
    <div id="bottom-border" class="border"></div>

    <div id="player"></div>

    <div id="fileControls">
        <label class="fileLabel" for="filePicker">Select Game Folder</label>
        <input type="file" id="filePicker" webkitdirectory multiple />
        <button id="loadSwf">Load SWF</button>
    </div>
</div>

<script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
<script src="RuffleAndroid/ruffle-virtual-keyboard.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const fileInput = document.getElementById("filePicker");
    const loadButton = document.getElementById("loadSwf");
    const playerContainer = document.getElementById("player");
    let filesMap = {}; // caminho relativo → ArrayBuffer
    let blobCache = {}; // Cache de Blob URLs

    // Configuração do Ruffle
    window.RufflePlayer = window.RufflePlayer || {};
    window.RufflePlayer.config = {
        allowScriptAccess: true,
        menu: false,
        logLevel: "warn",
        playerRuntime: "flashPlayer",
        maxExecutionDuration: 120
    };

    const ruffle = window.RufflePlayer.newest();
    let rufflePlayer = ruffle.createPlayer();
    playerContainer.appendChild(rufflePlayer);

    // Carrega todos os arquivos da pasta na memória
    fileInput.addEventListener("change", async (e) => {
        const files = Array.from(e.target.files);
        filesMap = {};
        blobCache = {};
        for (const file of files) {
            const arrayBuffer = await file.arrayBuffer();
            filesMap[file.webkitRelativePath] = arrayBuffer;
        }
        alert("Arquivos carregados na memória: " + Object.keys(filesMap).length);
    });

    // Cria loader virtual que retorna Blob URL para qualquer arquivo carregado
    function virtualLoader(path) {
        const key = Object.keys(filesMap).find(k => k.endsWith(path));
        if (!key) return null;
        if (!blobCache[key]) blobCache[key] = URL.createObjectURL(new Blob([filesMap[key]]));
        return blobCache[key];
    }

    // Monkey-patch do fetch para interceptar recursos carregados pelo SWF
    function patchFetch() {
        const originalFetch = window.fetch;
        window.fetch = async function(resource, ...args) {
            const url = virtualLoader(resource);
            if (url) return originalFetch(url, ...args);
            return originalFetch(resource, ...args);
        };
    }

    loadButton.addEventListener("click", () => {
        // Troque pelo nome do SWF principal, ex: "run.swf"
        const mainSwfPath = Object.keys(filesMap).find(k => k.endsWith("run.swf"));
        if (!mainSwfPath) {
            alert("SWF principal não encontrado!");
            return;
        }

        playerContainer.innerHTML = "";
        rufflePlayer = ruffle.createPlayer();
        playerContainer.appendChild(rufflePlayer);

        patchFetch(); // ativa loader virtual

        rufflePlayer.load(URL.createObjectURL(new Blob([filesMap[mainSwfPath]])));
    });
});
</script>

</body>
</html>
