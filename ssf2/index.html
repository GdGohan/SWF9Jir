<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruffle Game Loader Landscape</title>
<style>
html, body { margin: 0; padding: 0; height: 100%; width: 100%; background: black; overflow: hidden; }
body { display: flex; flex-direction: column; }

#fileControls {
    display: flex;
    gap: 10px;
    justify-content: center;
    align-items: center;
    padding: 10px;
    background: rgba(0,0,0,0.8);
    z-index: 10;
    position: fixed;
    top: 0;
    width: 100%;
}

button, label { padding: 12px 18px; background: #333; color: white; border-radius: 6px; cursor: pointer; font-size: 16px; }
input[type="file"] { display: none; }

#container {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 60px; /* espaço para os botões no topo */
    position: relative;
}

#player { 
    width: 100%; 
    height: 100%; 
    max-height: 100%; 
    background: #000; 
    position: relative; 
    z-index: 5; 
}

.border { position: absolute; z-index: 1; background-repeat: no-repeat; background-size: cover; background-position: center; }
#left-border, #right-border { top: 0; width: calc((100vw - (100vh * 16 / 9)) / 2); height: 100vh; }
#left-border { left: 0; background-image: url('RuffleAndroid/RuffleVKTextures/left_edge.png'); }
#right-border { right: 0; background-image: url('RuffleAndroid/RuffleVKTextures/right_edge.png'); }
#top-border, #bottom-border { left: 0; width: 100vw; height: calc((100vh - (100vw * 9 / 16)) / 2); }
#top-border { top: 0; background-image: url('RuffleAndroid/RuffleVKTextures/top_edge.png'); }
#bottom-border { bottom: 0; background-image: url('RuffleAndroid/RuffleVKTextures/bottom_edge.png'); }
@media (min-aspect-ratio: 16/9) { #top-border, #bottom-border { display: none; } }
@media (max-aspect-ratio: 16/9) { #left-border, #right-border { display: none; } }
</style>
</head>
<body>

<div id="fileControls">
    <label for="mainSwfPicker">Select Main SWF</label>
    <input type="file" id="mainSwfPicker" accept=".swf" />
    
    <label for="complementaryPicker">Add Complementary Files</label>
    <input type="file" id="complementaryPicker" multiple />

    <button id="loadSwf">Load SWF</button>
</div>

<div id="container">
    <div id="left-border" class="border"></div>
    <div id="right-border" class="border"></div>
    <div id="top-border" class="border"></div>
    <div id="bottom-border" class="border"></div>

    <div id="player"></div>
</div>

<script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
<script src="RuffleAndroid/ruffle-virtual-keyboard.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const mainSwfInput = document.getElementById("mainSwfPicker");
    const compInput = document.getElementById("complementaryPicker");
    const loadButton = document.getElementById("loadSwf");
    const playerContainer = document.getElementById("player");

    let filesMap = {};
    let blobCache = {};
    let mainSwfBuffer = null;

    // Configuração Ruffle
    window.RufflePlayer = window.RufflePlayer || {};
    window.RufflePlayer.config = {
        allowScriptAccess: true,
        menu: false,
        logLevel: "warn",
        playerRuntime: "air",
        maxExecutionDuration: 120
    };
    const ruffle = window.RufflePlayer.newest();
    let rufflePlayer = ruffle.createPlayer();
    playerContainer.appendChild(rufflePlayer);

    mainSwfInput.addEventListener("change", async (e) => {
        if (!e.target.files.length) return;
        const file = e.target.files[0];
        mainSwfBuffer = await file.arrayBuffer();
        alert(`Main SWF loaded: ${file.name}`);
    });

    compInput.addEventListener("change", async (e) => {
        const files = Array.from(e.target.files);
        for (const file of files) {
            const arrayBuffer = await file.arrayBuffer();
            filesMap[file.name] = arrayBuffer;
        }
        alert(`Complementary files added: ${files.length}`);
    });

    function virtualLoader(path) {
        const key = Object.keys(filesMap).find(k => k.endsWith(path));
        if (!key) return null;
        if (!blobCache[key]) blobCache[key] = URL.createObjectURL(new Blob([filesMap[key]]));
        return blobCache[key];
    }

    function patchFetch() {
        const originalFetch = window.fetch;
        window.fetch = async function(resource, ...args) {
            const url = virtualLoader(resource);
            if (url) return originalFetch(url, ...args);
            return originalFetch(resource, ...args);
        };
    }

    loadButton.addEventListener("click", () => {
        if (!mainSwfBuffer) {
            alert("Please select the main SWF first!");
            return;
        }

        playerContainer.innerHTML = "";
        rufflePlayer = ruffle.createPlayer();
        playerContainer.appendChild(rufflePlayer);

        patchFetch();

        rufflePlayer.load(URL.createObjectURL(new Blob([mainSwfBuffer])));
    });
});
</script>

</body>
</html>
