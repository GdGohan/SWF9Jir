<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruffle Game Loader Virtual Folder</title>
<style>
body, html {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: black;
    font-family: sans-serif;
}

#fileControls {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: rgba(0,0,0,0.85);
    position: sticky;
    top: 0;
    z-index: 10;
}

button, label, input[type="text"] {
    padding: 10px 14px;
    border-radius: 6px;
    background: #333;
    color: #fff;
    font-size: 14px;
    cursor: pointer;
    border: none;
}

input[type="file"] { display: none; }

#container {
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    width: 100%;
    flex: 1;
    overflow: auto;
}

#player {
    width: 100%;
    max-width: 100%;
    aspect-ratio: 16/9;
    background: #000;
    position: relative;
    z-index: 5;
}

/* Bordas */
.border {
    position: absolute;
    z-index: 1;
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center;
}

#left-border, #right-border {
    top: 0;
    bottom: 0;
    width: calc((100% - (16/9 * 100%)) / 2);
}

#left-border { left: 0; background-image: url('RuffleAndroid/RuffleVKTextures/left_edge.png'); }
#right-border { right: 0; background-image: url('RuffleAndroid/RuffleVKTextures/right_edge.png'); }

#top-border, #bottom-border {
    left: 0;
    width: 100%;
    height: calc((100% - (100% * 9 / 16)) / 2);
}

#top-border { top: 0; background-image: url('RuffleAndroid/RuffleVKTextures/top_edge.png'); }
#bottom-border { bottom: 0; background-image: url('RuffleAndroid/RuffleVKTextures/bottom_edge.png'); }

@media (min-aspect-ratio: 16/9) { #top-border, #bottom-border { display: none; } }
@media (max-aspect-ratio: 16/9) { #left-border, #right-border { display: none; } }
</style>
</head>
<body>

<div id="fileControls">
    <label for="mainSwfPicker">Select Main SWF</label>
    <input type="file" id="mainSwfPicker" accept=".swf">

    <label for="complementaryPicker">Add Complementary Files</label>
    <input type="file" id="complementaryPicker" multiple>

    <input type="text" id="virtualFolderName" placeholder="Virtual folder name (optional)">

    <button id="loadSwf">Load SWF</button>
</div>

<div id="container">
    <div id="left-border" class="border"></div>
    <div id="right-border" class="border"></div>
    <div id="top-border" class="border"></div>
    <div id="bottom-border" class="border"></div>

    <div id="player"></div>
</div>

<script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
<script src="RuffleAndroid/ruffle-virtual-keyboard.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const mainSwfInput = document.getElementById("mainSwfPicker");
    const compInput = document.getElementById("complementaryPicker");
    const folderInput = document.getElementById("virtualFolderName");
    const loadButton = document.getElementById("loadSwf");
    const playerContainer = document.getElementById("player");

    let mainSwfBuffer = null;
    let filesMap = {};  // "virtualFolder/filename" → ArrayBuffer
    let blobCache = {};

    // Configuração do Ruffle
    window.RufflePlayer = window.RufflePlayer || {};
    window.RufflePlayer.config = {
        allowScriptAccess: true,
        menu: false,
        logLevel: "warn",
        playerRuntime: "air",
        maxExecutionDuration: 120
    };
    const ruffle = window.RufflePlayer.newest();
    let rufflePlayer = ruffle.createPlayer();
    playerContainer.appendChild(rufflePlayer);

    // Seleciona SWF principal
    mainSwfInput.addEventListener("change", async (e) => {
        if (!e.target.files.length) return;
        const file = e.target.files[0];
        mainSwfBuffer = await file.arrayBuffer();
        alert(`Main SWF loaded: ${file.name}`);
    });

    // Seleciona complementares e armazena na pasta virtual
    compInput.addEventListener("change", async (e) => {
        const files = Array.from(e.target.files);
        const folderName = folderInput.value.trim();
        for (const file of files) {
            const buffer = await file.arrayBuffer();
            const path = folderName ? `${folderName}/${file.name}` : file.name;
            filesMap[path] = buffer;

            // também cria alias sem pasta, para compatibilidade
            if (folderName) filesMap[file.name] = buffer;
        }
        alert(`Complementary files added: ${files.length}`);
    });

    // Virtual loader para o SWF acessar arquivos na memória
    function virtualLoader(path) {
        const key = Object.keys(filesMap).find(k => k.endsWith(path));
        if (!key) return null;
        if (!blobCache[key]) blobCache[key] = URL.createObjectURL(new Blob([filesMap[key]]));
        return blobCache[key];
    }

    // Monkey-patch do fetch
    function patchFetch() {
        const originalFetch = window.fetch;
        window.fetch = async function(resource, ...args) {
            const url = virtualLoader(resource);
            if (url) return originalFetch(url, ...args);
            return originalFetch(resource, ...args);
        };
    }

    // Carrega SWF principal
    loadButton.addEventListener("click", () => {
        if (!mainSwfBuffer) { alert("Please select the main SWF first!"); return; }

        playerContainer.innerHTML = "";
        rufflePlayer = ruffle.createPlayer();
        playerContainer.appendChild(rufflePlayer);

        patchFetch();

        rufflePlayer.load(URL.createObjectURL(new Blob([mainSwfBuffer])));
    });
});
</script>

</body>
</html>
